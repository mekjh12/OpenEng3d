# 모션 클래스 시스템 기술 문서

## 1. 개요

이 모션 클래스는 3D 캐릭터의 애니메이션을 처리하기 위한 클래스입니다. Motion, KeyFrame, BoneTransform 세 개의 핵심 클래스가 계층적으로 구성되어 있으며, 각각 애니메이션 전체, 특정 시점의 포즈, 개별 뼈의 변환 정보를 담당합니다.

## 2. 클래스 구조와 관계

### Motion (애니메이션 전체 관리자)

Motion 클래스는 하나의 완전한 애니메이션을 표현하는 최상위 클래스입니다. 걷기, 뛰기, 점프와 같은 하나의 동작 시퀀스를 관리하며, 시간축에 따른 여러 개의 키프레임들을 Dictionary 형태로 저장합니다.

Motion 객체는 애니메이션의 이름과 전체 길이(초 단위)를 가지고 있으며, 시간을 키로 하여 해당 시점의 KeyFrame 객체들을 관리합니다. 예를 들어 2초짜리 걷기 애니메이션이라면, 0.0초, 0.5초, 1.0초, 1.5초, 2.0초와 같은 시간 지점에 각각의 키프레임이 저장될 수 있습니다. 딕셔너리의 용량은 C#에서 사용할 수 있는 양이다.

Motion의 가장 중요한 기능은 실시간 애니메이션 재생 시 임의의 시간 지점에서 캐릭터의 포즈를 계산하는 것입니다. 만약 0.7초 시점의 포즈가 필요하다면, 0.5초와 1.0초 키프레임 사이를 보간하여 자연스러운 중간 포즈를 생성합니다. 보간을 실행하는 함수는 InterpolatePoseAtTime()이다.

### KeyFrame (특정 시점의 전체 포즈)
KeyFrame 클래스는 애니메이션의 특정 시간 지점에서 캐릭터 전체의 포즈를 저장하는 역할을 합니다. 하나의 키프레임은 해당 시점에서 모든 뼈들의 상태를 담고 있습니다.

KeyFrame 내부에는 뼈의 이름을 키로 하고 BoneTransform을 값으로 하는 Dictionary가 있어서, "spine", "left_arm", "right_leg" 같은 뼈 이름으로 각 뼈의 변환 정보에 접근할 수 있습니다. 예를 들어 키프레임[1.0초]에서 "right_arm" 뼈의 회전 각도나 위치를 조회하고 수정할 수 있습니다. 

각 KeyFrame은 자신이 속한 시간(TimeStamp)을 기억하고 있으며, 필요시 자신을 복사하는 Clone 기능도 제공합니다. 이는 애니메이션 편집이나 블렌딩 작업에서 유용하게 사용됩니다.

### BoneTransform (개별 뼈의 변환 정보)
BoneTransform은 하나의 뼈가 가질 수 있는 모든 변환 정보를 저장하는 구조체입니다. 3D 그래픽스에서 객체의 변환은 일반적으로 위치(Position), 회전(Rotation), 크기(Scaling)로 구성되며, BoneTransform도 이 세 가지 요소를 모두 포함합니다.

위치는 **부모 뼈를 기준으로 한 상대적인 3D 좌표**이고, 회전은 쿼터니언(Quaternion)으로 표현되어 짐벌락 현상 없이 자연스러운 회전을 처리할 수 있습니다. 크기는 뼈의 스케일링 비율을 나타냅니다.

BoneTransform의 핵심 기능은 두 BoneTransform 상태 사이의 부드러운 보간(Interpolation)입니다. 애니메이션에서 키프레임 사이의 중간 포즈를 계산할 때, 각 뼈의 BoneTransform들이 개별적으로 보간되어 자연스러운 움직임을 만들어냅니다.

## 3. 동작 원리

### 애니메이션 재생 과정

애니메이션이 재생될 때의 과정은 다음과 같습니다:

1. **시간 계산**: 현재 애니메이션 재생 시간을 계산합니다 (예: 0.7초)
2. **키프레임 검색**: Motion에서 해당 시간 주변의 두 키프레임을 찾습니다 (예: 0.5초와 1.0초)
3. **보간 비율 계산**: 두 키프레임 사이에서 현재 시간의 위치를 0~1 사이의 비율로 계산합니다 (예: 0.4)
4. **뼈별 보간**: 각 뼈에 대해 두 키프레임의 BoneTransform을 보간하여 현재 포즈를 계산합니다
5. **변환 행렬 생성**: 각 뼈의 BoneTransform을 4x4 변환 행렬로 변환하여 렌더링 시스템에 전달합니다

### 키프레임 보간의 세부 과정

Motion의 InterpolatePoseAtTime 메소드는 이 보간 과정의 핵심입니다. 먼저 요청된 시간에 가장 가까운 이전 키프레임과 다음 키프레임을 찾습니다. 그 다음 시간적 진행률을 계산하여 각 뼈의 BoneTransform들을 개별적으로 보간합니다.
위치는 선형 보간을, 회전은 구면 선형 보간(SLERP)을 사용하여 자연스러운 회전 움직임을 보장합니다. 크기 또한 선형 보간을 통해 처리됩니다.

### 예외 상황 처리

시스템은 다양한 예외 상황들을 고려하여 설계되었습니다. 쿼터니언 계산 과정에서 NaN 값이 발생할 경우 대체 포즈를 사용하며, 키프레임이 없는 시간에 대해서는 가장 가까운 키프레임을 사용합니다.
빈 프레임이 있는 경우 InterpolateEmptyFrame 메소드를 통해 앞뒤 프레임을 이용한 자동 보간이 가능하며, 이는 애니메이션 제작 과정에서 모든 프레임을 수동으로 설정할 필요가 없게 해줍니다.

## 4. 확장 기능

### 모션 블렌딩

BlendMotion 정적 메소드는 두 개의 서로 다른 애니메이션을 자연스럽게 연결하는 기능을 제공합니다. 예를 들어 걷기에서 뛰기로 전환할 때, 급작스러운 변화 대신 부드러운 전환을 만들어낼 수 있습니다.

### 실시간 편집

각 클래스의 Clone 메소드들은 실시간 애니메이션 편집을 지원합니다. 원본 데이터를 훼손하지 않고 복사본을 만들어 실험적인 수정이나 변형을 적용할 수 있습니다.

### 데이터 접근성

모든 클래스는 내부 데이터에 대한 안전한 접근 방법을 제공합니다. Motion은 키프레임 목록을, KeyFrame은 뼈 이름 목록을, BoneTransform은 개별 변환 요소들을 각각 조회할 수 있는 속성들을 제공합니다.

## 5. 사용 시나리오 예시

### 기본 애니메이션 생성

```
1. Motion 객체 생성 (이름: "walk", 길이: 2.0초)
2. 주요 시간 지점에 KeyFrame 추가 (0.0초, 0.5초, 1.0초, 1.5초, 2.0초)
3. 각 KeyFrame에 필요한 뼈들의 BoneTransform 설정
4. 빈 프레임이 있다면 InterpolateEmptyFrame으로 자동 보간
```

### 런타임 애니메이션 재생

```
1. 현재 재생 시간 계산 (예: 게임 시간 * 애니메이션 속도)
2. Motion.InterpolatePoseAtTime 호출하여 현재 포즈 획득
3. 반환된 변환 행렬들을 3D 렌더링 시스템에 적용
4. 매 프레임마다 반복하여 부드러운 애니메이션 구현
```

이러한 구조를 통해 복잡한 3D 캐릭터 애니메이션을 체계적이고 효율적으로 관리할 수 있으며, 실시간 성능과 편집 유연성을 모두 확보할 수 있습니다.